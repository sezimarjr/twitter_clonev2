<!DOCTYPE html>
<html lang="pt-br">
  <head>
    {% load static %}
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="{% static 'css/profile.css' %}" />
    <title>Perfil de {{profile.user}}</title>
  </head>
  <body>
    <div class="container">
      <aside>
        <ul>
          <li>
            {% load static %}
            <img src="{%static 'images/just-bird.png'%}" alt="Pia Dai Logo" />
          </li>
          <li>
            {% load static %}
            <img
              class="icon-menu"
              src="{%static 'images/botao-de-inicio.png'%}"
              alt="Home"
            />
            <a href="{%url 'core:index'%}">Home</a>
          </li>
          <li>
            {% load static %}
            <img
              class="icon-menu"
              src="{%static 'images/lupa.png'%}"
              alt="Explorar"
            />
            Explorar
          </li>
          <li>
            {% load static %}
            <img
              class="icon-menu"
              src="{%static 'images/notificacao.png'%}"
              alt="Notificação"
            />
            Notificações
          </li>
          <li>
            {% load static %}
            <img
              class="icon-menu"
              src="{%static 'images/mensagens.png'%}"
              alt="Mensagem"
            />
            Mensagens
          </li>
          <li>
            {% load static %}
            <img
              class="icon-menu"
              src="{%static 'images/perfil.png'%}"
              alt="Perfil"
            />
            {% if profile.user == user %} <b>Perfil</b> {% else %}
            <a href="{%url 'core:profile' username=request.user.username%}"
              >Perfil</a
            >
            {% endif %}
          </li>
        </ul>

        <form action="{%url 'core:logout'%}" method="post">
          {% csrf_token %} {% load static %}
          <div class="user_logout">
            <img
              class="avatar"
              src="{{user.profile.avatar.url}}"
              alt="{{user.username}}"
            />

            <button type="submit">Logout</button>
          </div>
        </form>
      </aside>
      <main>
        <div class="profile">
          {% load static %}
          <div class="profile__background">
            <img
              id="profile-avatar"
              class="profile__avatar"
              src="{{profile.avatar.url}}"
              alt="{{profile.user}}"
              onclick="document.getElementById('avatar-input').click()"
              style="cursor: pointer"
            />
            <!-- Formulário oculto para upload -->
            <input
              type="file"
              id="avatar-input"
              accept="image/*"
              style="display: none"
              onchange="uploadAvatar(this.files)"
            />
            />
          </div>
        </div>
        <div class="profile__content">
          <h1>{{profile.user}}</h1>
          <p>Joined {{profile.user.date_joined|date:"j \d\e F \d\e Y"}}</p>
        </div>

        {% for post in posts %}
        <div class="border-top"></div>
        <div class="post__container">
          <a href="{%url 'core:profile' username=post.user.username%}">
            <img
              class="post__img"
              src="{{post.user.profile.avatar.url}}"
              alt=""
            />
          </a>

          <div class="post__content">
            <h3>
              <a href="{%url 'core:profile' username=post.user.username%}">
                {{post.user}}
              </a>
              <span class="post__date">
                {{post.created_at|date:"d M"}} {{post.created_at|date:"H:i"}}
              </span>
            </h3>
            <p>{{post.content|linebreaksbr }}</p>

            <div class="post__likes">
              <div
                class="{% if post.liked_by_user %}heart is-active{% else %}heart{% endif %}"
                onclick="likePost({{ post.id }})"
                id="heart-{{ post.id }}"
              ></div>
              <span class="post__likes-count" id="like-count-{{ post.id }}"
                >{{ post.total_likes }}</span
              >
            </div>
          </div>
        </div>
        {% endfor %}
      </main>
      <div id="suggestions">
        <div class="suggestions-header">
          <h4>Novos usuários</h4>
        </div>

        <div class="users-list">
          {% for profile in new_users %}
          <a
            href="{% url 'core:profile' username=profile.user.username %}"
            class="user-item"
          >
            <img
              src="{{ profile.avatar.url }}"
              alt="{{ profile.user.username }}"
              class="user-avatar"
            />
            <span class="username">{{ profile.user.username }}</span>
          </a>
          {% endfor %}
        </div>
      </div>
    </div>
  </body>
  <script>
    function uploadAvatar(files) {
      if (files.length === 0) return;

      // Validação de tamanho (2MB)
      if (files[0].size > 2 * 1024 * 1024) {
        alert("A imagem deve ter no máximo 2MB!");
        return; // Impede o envio
      }

      // Restante do código do fetch...
      const formData = new FormData();
      formData.append("avatar", files[0]);
      formData.append("csrfmiddlewaretoken", "{{ csrf_token }}");

      fetch("{% url 'core:update_avatar' %}", {
        method: "POST",
        body: formData,
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            // Atualiza a imagem
            document.getElementById("profile-avatar").src =
              data.avatar_url + "?t=" + Date.now();
            window.location.reload();
          } else {
            alert(data.error || "Erro ao atualizar avatar.");
          }
        })
        .catch((error) => console.error("Erro:", error));
    }
    function likePost(postId) {
      fetch(`/post/${postId}/like/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]")
            .value,
        },
      })
        .then((response) => response.json())
        .then((data) => {
          console.log(data);
          if (data.error) {
            alert("Erro ao curtir o post!");
            return;
          }

          // Atualiza o contador de curtidas
          const likeCount = document.getElementById(`like-count-${postId}`);
          likeCount.textContent = data.total_likes; // Atualiza o número de curtidas
          console.log(data.total_likes);

          heart = document.querySelector("#heart-" + postId);
          heart.classList.toggle("is-active");
        })
        .catch((error) => {
          console.error("Erro:", error);
        });
    }
  </script>
</html>
